# Makefile for module_pipeline
# La MÃ¡quina de Noticias - Pipeline Module
# 
# Comandos disponibles:
#   make help     - Mostrar esta ayuda
#   make setup    - ConfiguraciÃ³n inicial del proyecto
#   make dev      - Ejecutar en modo desarrollo
#   make test     - Ejecutar tests
#   make build    - Construir imagen Docker
#   make deploy   - Desplegar con Docker Compose
#   make clean    - Limpiar archivos temporales

.PHONY: help setup dev test test-cov build deploy clean logs health metrics

# === CONFIGURACIÃ“N ===
DOCKER_IMAGE_NAME = lamaquina/module-pipeline
DOCKER_TAG = latest
PROJECT_NAME = module_pipeline
PYTHON = python3
PIP = pip3

# === COLORES PARA OUTPUT ===
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# === COMANDO POR DEFECTO ===
help: ## Mostrar esta ayuda
	@echo "$(BLUE)La MÃ¡quina de Noticias - Module Pipeline$(NC)"
	@echo "$(YELLOW)Comandos disponibles:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}'

# === CONFIGURACIÃ“N INICIAL ===
setup: ## ConfiguraciÃ³n inicial del proyecto
	@echo "$(BLUE)ğŸ”§ Configurando proyecto module_pipeline...$(NC)"
	@echo "$(YELLOW)Verificando Python...$(NC)"
	@$(PYTHON) --version
	@echo "$(YELLOW)Creando entorno virtual...$(NC)"
	@$(PYTHON) -m venv venv
	@echo "$(YELLOW)Activando entorno e instalando dependencias...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && $(PIP) install --upgrade pip && $(PIP) install -r requirements.txt; \
	else \
		. venv/Scripts/activate && $(PIP) install --upgrade pip && $(PIP) install -r requirements.txt; \
	fi
	@echo "$(YELLOW)Descargando modelos spaCy...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && python -m spacy download es_core_news_lg && python -m spacy download en_core_web_sm; \
	else \
		. venv/Scripts/activate && python -m spacy download es_core_news_lg && python -m spacy download en_core_web_sm; \
	fi
	@echo "$(YELLOW)Creando archivo .env desde .env.example...$(NC)"
	@if [ ! -f ".env" ]; then cp .env.example .env; fi
	@echo "$(YELLOW)Creando directorios necesarios...$(NC)"
	@mkdir -p logs logs/development metrics
	@echo "$(GREEN)âœ… ConfiguraciÃ³n inicial completada!$(NC)"
	@echo "$(YELLOW)ğŸ“ IMPORTANTE: Edita .env con tus API keys antes de continuar$(NC)"

# === DESARROLLO ===
dev: ## Ejecutar en modo desarrollo
	@echo "$(BLUE)ğŸš€ Iniciando servidor de desarrollo...$(NC)"
	@if [ -f ".env" ]; then \
		echo "$(GREEN)Archivo .env encontrado$(NC)"; \
	else \
		echo "$(RED)âŒ Archivo .env no encontrado. Ejecuta 'make setup' primero$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)Iniciando FastAPI en http://localhost:8003$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && cd src && python main.py; \
	else \
		. venv/Scripts/activate && cd src && python main.py; \
	fi

dev-docker: ## Ejecutar en modo desarrollo con Docker
	@echo "$(BLUE)ğŸ³ Iniciando con Docker Compose...$(NC)"
	@docker-compose up -d module-pipeline
	@echo "$(GREEN)âœ… Servidor iniciado en http://localhost:8003$(NC)"
	@echo "$(YELLOW)ğŸ“Š MÃ©tricas disponibles en http://localhost:8003/metrics$(NC)"

# === TESTING ===
test: ## Ejecutar tests
	@echo "$(BLUE)ğŸ§ª Ejecutando tests...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && pytest; \
	else \
		. venv/Scripts/activate && pytest; \
	fi

test-cov: ## Ejecutar tests con cobertura
	@echo "$(BLUE)ğŸ§ª Ejecutando tests con reporte de cobertura...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && pytest --cov=src --cov-report=html --cov-report=term; \
	else \
		. venv/Scripts/activate && pytest --cov=src --cov-report=html --cov-report=term; \
	fi
	@echo "$(GREEN)ğŸ“Š Reporte HTML generado en htmlcov/index.html$(NC)"

test-specific: ## Ejecutar tests especÃ­ficos (uso: make test-specific TEST=test_file.py)
	@echo "$(BLUE)ğŸ§ª Ejecutando test especÃ­fico: $(TEST)$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && pytest $(TEST) -v; \
	else \
		. venv/Scripts/activate && pytest $(TEST) -v; \
	fi

# === DOCKER ===
build: ## Construir imagen Docker
	@echo "$(BLUE)ğŸ³ Construyendo imagen Docker...$(NC)"
	@docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
	@echo "$(GREEN)âœ… Imagen construida: $(DOCKER_IMAGE_NAME):$(DOCKER_TAG)$(NC)"

deploy: ## Desplegar con Docker Compose
	@echo "$(BLUE)ğŸš€ Desplegando con Docker Compose...$(NC)"
	@if [ ! -f ".env" ]; then \
		echo "$(RED)âŒ Archivo .env no encontrado$(NC)"; \
		exit 1; \
	fi
	@docker-compose up -d
	@echo "$(GREEN)âœ… Servicios desplegados:$(NC)"
	@echo "  ğŸ“¡ Pipeline API: http://localhost:8003"
	@echo "  ğŸ“Š Prometheus: http://localhost:9090"
	@echo "  ğŸ“ˆ Grafana: http://localhost:3001"

deploy-prod: ## Desplegar solo el pipeline (sin monitoreo)
	@echo "$(BLUE)ğŸš€ Desplegando pipeline en modo producciÃ³n...$(NC)"
	@docker-compose up -d module-pipeline
	@echo "$(GREEN)âœ… Pipeline desplegado en http://localhost:8003$(NC)"

# === OPERACIONES ===
logs: ## Ver logs del pipeline
	@echo "$(BLUE)ğŸ“‹ Mostrando logs del pipeline...$(NC)"
	@docker-compose logs -f module-pipeline

health: ## Verificar salud del sistema
	@echo "$(BLUE)ğŸ¥ Verificando salud del sistema...$(NC)"
	@curl -s http://localhost:8003/health | python -m json.tool || echo "$(RED)âŒ Servicio no disponible$(NC)"
	@echo ""
	@curl -s http://localhost:8003/health/detailed | python -m json.tool || echo "$(RED)âŒ Health check detallado no disponible$(NC)"

metrics: ## Ver mÃ©tricas del sistema
	@echo "$(BLUE)ğŸ“Š MÃ©tricas del sistema:$(NC)"
	@curl -s http://localhost:8003/metrics || echo "$(RED)âŒ MÃ©tricas no disponibles$(NC)"

status: ## Ver estado del pipeline
	@echo "$(BLUE)âš™ï¸ Estado del pipeline:$(NC)"
	@curl -s http://localhost:8003/monitoring/pipeline-status | python -m json.tool || echo "$(RED)âŒ Estado no disponible$(NC)"

# === LIMPIEZA ===
clean: ## Limpiar archivos temporales
	@echo "$(BLUE)ğŸ§¹ Limpiando archivos temporales...$(NC)"
	@find . -type f -name "*.pyc" -delete
	@find . -type d -name "__pycache__" -delete
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@find . -type f -name "*.tmp" -delete 2>/dev/null || true
	@rm -rf logs/*.log metrics/*.json 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

clean-docker: ## Limpiar contenedores e imÃ¡genes Docker
	@echo "$(BLUE)ğŸ³ Limpiando recursos Docker...$(NC)"
	@docker-compose down --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)âœ… Recursos Docker limpiados$(NC)"

# === UTILIDADES ===
shell: ## Abrir shell en el contenedor
	@echo "$(BLUE)ğŸš Abriendo shell en el contenedor...$(NC)"
	@docker-compose exec module-pipeline /bin/bash

install-deps: ## Reinstalar dependencias
	@echo "$(BLUE)ğŸ“¦ Reinstalando dependencias...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && $(PIP) install --upgrade pip && $(PIP) install -r requirements.txt; \
	else \
		. venv/Scripts/activate && $(PIP) install --upgrade pip && $(PIP) install -r requirements.txt; \
	fi

format: ## Formatear cÃ³digo con black
	@echo "$(BLUE)ğŸ¨ Formateando cÃ³digo...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && black src/ tests/; \
	else \
		. venv/Scripts/activate && black src/ tests/; \
	fi

lint: ## Verificar cÃ³digo con flake8
	@echo "$(BLUE)ğŸ” Verificando cÃ³digo...$(NC)"
	@if [ -f "venv/bin/activate" ]; then \
		. venv/bin/activate && flake8 src/ tests/; \
	else \
		. venv/Scripts/activate && flake8 src/ tests/; \
	fi

# === INFORMACIÃ“N ===
info: ## Mostrar informaciÃ³n del proyecto
	@echo "$(BLUE)ğŸ“‹ InformaciÃ³n del proyecto:$(NC)"
	@echo "  $(YELLOW)Proyecto:$(NC) $(PROJECT_NAME)"
	@echo "  $(YELLOW)Imagen Docker:$(NC) $(DOCKER_IMAGE_NAME):$(DOCKER_TAG)"
	@echo "  $(YELLOW)Puerto API:$(NC) 8003"
	@echo "  $(YELLOW)Directorio:$(NC) $(PWD)"
	@echo "  $(YELLOW)Python:$(NC) $(shell $(PYTHON) --version 2>&1)"
	@echo "  $(YELLOW)Docker:$(NC) $(shell docker --version 2>&1 || echo 'No instalado')"
	@echo "  $(YELLOW)Docker Compose:$(NC) $(shell docker-compose --version 2>&1 || echo 'No instalado')"

# === DOCUMENTACIÃ“N ===
docs: ## Generar documentaciÃ³n
	@echo "$(BLUE)ğŸ“š La documentaciÃ³n estÃ¡ en README.md$(NC)"
	@echo "  ğŸ“– Estructura del proyecto: README.md"
	@echo "  ğŸ”§ ConfiguraciÃ³n: .env.example"
	@echo "  ğŸ§ª Tests: tests/README.md"
	@echo "  ğŸ“Š API Docs: http://localhost:8003/docs (cuando estÃ© ejecutÃ¡ndose)"

# === COMANDOS RÃPIDOS ===
up: deploy ## Alias para deploy
down: ## Detener todos los servicios
	@docker-compose down
	@echo "$(GREEN)âœ… Servicios detenidos$(NC)"

restart: ## Reiniciar servicios
	@echo "$(BLUE)ğŸ”„ Reiniciando servicios...$(NC)"
	@docker-compose restart
	@echo "$(GREEN)âœ… Servicios reiniciados$(NC)"
