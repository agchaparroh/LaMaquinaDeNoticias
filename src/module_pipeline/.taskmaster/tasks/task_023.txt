# Task ID: 23
# Title: Implement asynchronous processing
# Status: done
# Dependencies: 19, 20, 21
# Priority: medium
# Description: Modify the controller and API endpoints to support asynchronous processing of articles and fragments.
# Details:
1. Update controller.py to use async/await syntax
2. Modify process_article() and process_fragment() to be asynchronous
3. Update API endpoints to use background tasks for processing
4. Implement a job queue system (e.g., using Redis or RabbitMQ) if required
5. Ensure proper handling of concurrent requests

# Test Strategy:
Create tests that simulate concurrent API calls. Verify that processing occurs asynchronously and that the system handles multiple simultaneous requests correctly.

# Subtasks:
## 23.1. Crear mÃ©todos de procesamiento en background en el controller [done]
### Dependencies: None
### Description: Implementar mÃ©todos de procesamiento en background para artÃ­culos y fragmentos en el controller.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/src/controller.py` - AÃ±adir mÃ©todos _process_article_background y _process_fragment_background
  - `/src/services/job_tracker_service.py` - Entender cÃ³mo actualizar estados del job
- **ğŸ“š DocumentaciÃ³n Context7**:
  - No aplica especÃ­ficamente - usar patrones del cÃ³digo existente
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Crear mÃ©todo `_process_article_background(self, articulo_data: Dict, job_id: str)`
  - Crear mÃ©todo `_process_fragment_background(self, fragmento_data: Dict, job_id: str)`
  - Ambos mÃ©todos deben actualizar el job tracker al inicio, durante y al final
  - Manejar errores y actualizar job status a FAILED si algo falla
  - Usar el mismo flujo que los mÃ©todos sÃ­ncronos existentes

## 23.2. Implementar lÃ³gica de decisiÃ³n para procesamiento asÃ­ncrono [done]
### Dependencies: None
### Description: Definir cuÃ¡ndo usar procesamiento asÃ­ncrono basado en el tamaÃ±o del contenido.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/src/main.py` - Modificar endpoint `/procesar_articulo` (lÃ­neas ~380-400 tienen ejemplo)
  - `/src/utils/config.py` - Verificar si hay configuraciÃ³n para thresholds
- **ğŸ“š DocumentaciÃ³n Context7**:
  - SecciÃ³n de optimizaciÃ³n para artÃ­culos largos mencionada en comentarios
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Definir constante `ASYNC_PROCESSING_THRESHOLD = 10_000` caracteres
  - En endpoint `procesar_articulo`: si len(contenido) > threshold, usar BackgroundTasks
  - En endpoint `procesar_fragmento`: aplicar misma lÃ³gica
  - Retornar respuesta inmediata con job_id y endpoint de status
  - Mantener procesamiento sÃ­ncrono para contenido pequeÃ±o

## 23.3. Actualizar endpoints para usar BackgroundTasks [done]
### Dependencies: None
### Description: Modificar los endpoints para soportar procesamiento en segundo plano con FastAPI BackgroundTasks.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/src/main.py` - Modificar endpoints procesar_articulo y procesar_fragmento
  - `/src/main.py` - Seguir el patrÃ³n del ejemplo comentado en lÃ­neas 380-400
- **ğŸ“š DocumentaciÃ³n Context7**:
  - FastAPI BackgroundTasks documentation pattern
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Usar `background_tasks.add_task()` cuando se detecte contenido largo
  - Pasar el mÃ©todo del controller apropiado como task
  - Incluir job_id y todos los datos necesarios
  - Retornar respuesta con estructura: success, job_id, status="processing", tracking info
  - Estimar tiempo de procesamiento basado en longitud (ejemplo: longitud/100 segundos)

## 23.4. Asegurar manejo robusto de concurrencia [done]
### Dependencies: None
### Description: Verificar y mejorar el manejo de concurrencia en el sistema para evitar problemas con mÃºltiples solicitudes simultÃ¡neas.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/src/controller.py` - Revisar si hay estado compartido que pueda causar problemas
  - `/src/services/job_tracker_service.py` - Verificar thread-safety (ya implementado)
- **ğŸ“š DocumentaciÃ³n Context7**:
  - Patrones de concurrencia y thread-safety
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Verificar que GroqService y SupabaseService manejen concurrencia correctamente
  - Asegurar que cada procesamiento tenga su propio contexto (request_id Ãºnico)
  - No compartir estado mutable entre procesamiento de diferentes requests
  - Documentar cualquier limitaciÃ³n de concurrencia encontrada

## 23.5. Test de VerificaciÃ³n Simple [completed]
### Dependencies: None
### Description: Crear pruebas para verificar el funcionamiento correcto del procesamiento asÃ­ncrono.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/tests/` - Crear script test_async_processing.py
  - `/src/main.py` - Endpoints a probar
  - `/src/controller.py` - MÃ©todos background a verificar
- **ğŸ“š DocumentaciÃ³n Context7**:
  - Patrones de testing existentes en el proyecto
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Crear script que envÃ­e un artÃ­culo largo (>10k caracteres) vÃ­a POST
  - Verificar que retorna inmediatamente con status="processing"
  - Consultar endpoint /status/{job_id} periÃ³dicamente
  - Verificar que el job pasa por estados: pending -> processing -> completed
  - Crear segundo test con mÃºltiples requests concurrentes
  - Verificar que el sistema maneja correctamente mÃºltiples jobs
  - Output claro: "âœ… Test asÃ­ncrono exitoso" o "âŒ Error: [detalles]"

## 23.6. Revisar resultados de pruebas y ajustar implementaciÃ³n [done]
### Dependencies: None
### Description: Analizar los resultados de las pruebas completadas y realizar ajustes necesarios en la implementaciÃ³n.
### Details:
- **ğŸ“ Documentos del repositorio**:
  - `/tests/test_async_processing.py` - Revisar resultados de pruebas completadas
  - `/src/controller.py` - Ajustar implementaciÃ³n segÃºn resultados
  - `/src/main.py` - Refinar endpoints segÃºn feedback de pruebas
- **ğŸ“š DocumentaciÃ³n Context7**:
  - Patrones de optimizaciÃ³n basados en resultados de pruebas
- **ğŸ”§ Especificaciones de implementaciÃ³n**:
  - Revisar los resultados de las pruebas completadas en test_async_processing.py
  - Verificar que el procesamiento asÃ­ncrono funciona correctamente para artÃ­culos largos
  - Confirmar que el procesamiento sÃ­ncrono se mantiene para artÃ­culos pequeÃ±os
  - Asegurar que el manejo de mÃºltiples requests concurrentes es robusto
  - Realizar ajustes en la implementaciÃ³n basados en cualquier problema identificado
  - Documentar cualquier optimizaciÃ³n adicional realizada

