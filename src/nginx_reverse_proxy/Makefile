# Makefile - nginx_reverse_proxy simple operations
# Comandos Ãºtiles para desarrollo y deployment

.PHONY: help build deploy stop clean test logs status integrate test-unit test-integration test-all test-coverage

# Default target
help:
	@echo "ðŸš€ nginx_reverse_proxy - Available Commands"
	@echo "==========================================="
	@echo ""
	@echo "ðŸ“¦ Build & Deploy:"
	@echo "  make build      - Build Docker image"
	@echo "  make deploy     - Deploy standalone"
	@echo "  make integrate  - Integrate with main docker-compose.yml"
	@echo ""
	@echo "ðŸ”§ Operations:"
	@echo "  make stop       - Stop container"
	@echo "  make clean      - Stop and remove container"
	@echo "  make restart    - Restart container"
	@echo ""
	@echo "ðŸ§ª Testing & Monitoring:"
	@echo "  make test       - Run health checks"
	@echo "  make test-all   - Run all pytest tests"
	@echo "  make test-unit  - Run unit tests only"
	@echo "  make test-integration - Run integration tests only"
	@echo "  make test-coverage - Run tests with coverage report"
	@echo "  make logs       - Show container logs"
	@echo "  make status     - Show container status"
	@echo ""
	@echo "ðŸ’¡ Usage Examples:"
	@echo "  make deploy && make test    # Full deployment & test"
	@echo "  make test-all               # Run all pytest tests"
	@echo "  make logs                   # Monitor in real-time"

# Build Docker image
build:
	@echo "ðŸ“¦ Building nginx_reverse_proxy..."
	docker build -t nginx_reverse_proxy .
	@echo "âœ… Build completed!"

# Deploy standalone
deploy:
	@echo "ðŸš€ Deploying nginx_reverse_proxy..."
	chmod +x scripts/deploy.sh
	./scripts/deploy.sh

# Integrate with main system
integrate:
	@echo "ðŸ”— Integrating with main system..."
	chmod +x scripts/integration.sh
	./scripts/integration.sh

# Stop container
stop:
	@echo "ðŸ›‘ Stopping nginx_reverse_proxy..."
	-docker stop nginx_reverse_proxy
	@echo "âœ… Container stopped"

# Clean up (stop + remove)
clean:
	@echo "ðŸ§¹ Cleaning up nginx_reverse_proxy..."
	-docker stop nginx_reverse_proxy
	-docker rm nginx_reverse_proxy
	@echo "âœ… Cleanup completed"

# Restart container
restart: stop
	@echo "ðŸ”„ Restarting nginx_reverse_proxy..."
	docker start nginx_reverse_proxy || make deploy
	@echo "âœ… Container restarted"

# Run health checks
test:
	@echo "ðŸ§ª Running health checks..."
	@echo "Testing nginx health..."
	@curl -f http://localhost/nginx-health && echo "âœ… Health: OK" || echo "âŒ Health: FAILED"
	@echo "Testing API routing..."
	@curl -I http://localhost/api/ &>/dev/null && echo "âœ… API: OK" || echo "âš ï¸  API: No backend"
	@echo "Testing frontend routing..."
	@curl -I http://localhost/ &>/dev/null && echo "âœ… Frontend: OK" || echo "âš ï¸  Frontend: No frontend"

# Show logs
logs:
	@echo "ðŸ“‹ Showing nginx_reverse_proxy logs..."
	docker logs -f nginx_reverse_proxy

# Show status
status:
	@echo "ðŸ“Š nginx_reverse_proxy Status:"
	@docker ps --filter "name=nginx_reverse_proxy" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}" || echo "Container not running"
	@echo ""
	@echo "ðŸŒ Endpoints:"
	@echo "  Health: http://localhost/nginx-health"
	@echo "  API:    http://localhost/api/"
	@echo "  Frontend: http://localhost/"

# Development helpers
dev-logs:
	@echo "ðŸ“‹ Development logs (access + error)..."
	@docker exec nginx_reverse_proxy sh -c "tail -f /var/log/nginx/access.log & tail -f /var/log/nginx/error.log" 2>/dev/null || echo "Container not running"

dev-shell:
	@echo "ðŸš Opening shell in nginx container..."
	docker exec -it nginx_reverse_proxy sh

dev-config:
	@echo "ðŸ”§ Showing nginx configuration..."
	docker exec nginx_reverse_proxy cat /etc/nginx/nginx.conf

# Network operations
network-create:
	@echo "ðŸ“¡ Creating lamacquina_network..."
	docker network create lamacquina_network || echo "Network already exists"

network-inspect:
	@echo "ðŸ” Inspecting lamacquina_network..."
	docker network inspect lamacquina_network

# Quick operations
quick-deploy: build deploy test

quick-restart: stop deploy test

quick-clean: clean build deploy test

# Pytest test commands
test-deps:
	@echo "ðŸ“¦ Installing test dependencies..."
	@pip install -q -r requirements-test.txt 2>/dev/null || pip install -r requirements-test.txt

test-unit: test-deps
	@echo "ðŸ“ Running unit tests..."
	@pytest tests/unit/ -v --tb=short

test-integration: test-deps network-create
	@echo "ðŸ”— Running integration tests..."
	@echo "âš ï¸  Note: This will create temporary containers"
	@pytest tests/integration/ -v --tb=short
	@echo "ðŸ§¹ Cleaning up test containers..."
	@docker rm -f nginx_reverse_proxy_test mock_dashboard_backend mock_dashboard_frontend 2>/dev/null || true

test-all: test-deps network-create
	@echo "ðŸ§ª Running all tests..."
	@pytest tests/ -v --tb=short
	@echo "ðŸ§¹ Cleaning up test containers..."
	@docker rm -f nginx_reverse_proxy_test mock_dashboard_backend mock_dashboard_frontend 2>/dev/null || true

test-coverage: test-deps network-create
	@echo "ðŸ“Š Running tests with coverage..."
	@pytest tests/ --cov=. --cov-report=term-missing --cov-report=html
	@echo "ðŸ§¹ Cleaning up test containers..."
	@docker rm -f nginx_reverse_proxy_test mock_dashboard_backend mock_dashboard_frontend 2>/dev/null || true
	@echo "ðŸ“ˆ Coverage report generated in htmlcov/index.html"

test-clean:
	@echo "ðŸ§¹ Cleaning test artifacts..."
	@docker rm -f nginx_reverse_proxy_test mock_dashboard_backend mock_dashboard_frontend 2>/dev/null || true
	@rm -rf .pytest_cache htmlcov .coverage 2>/dev/null || true
