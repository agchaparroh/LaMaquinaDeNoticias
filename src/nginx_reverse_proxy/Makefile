# Makefile - nginx_reverse_proxy simple operations
# Comandos Ãºtiles para desarrollo y deployment

.PHONY: help build deploy stop clean test logs status integrate

# Default target
help:
	@echo "ğŸš€ nginx_reverse_proxy - Available Commands"
	@echo "==========================================="
	@echo ""
	@echo "ğŸ“¦ Build & Deploy:"
	@echo "  make build      - Build Docker image"
	@echo "  make deploy     - Deploy standalone"
	@echo "  make integrate  - Integrate with main docker-compose.yml"
	@echo ""
	@echo "ğŸ”§ Operations:"
	@echo "  make stop       - Stop container"
	@echo "  make clean      - Stop and remove container"
	@echo "  make restart    - Restart container"
	@echo ""
	@echo "ğŸ§ª Testing & Monitoring:"
	@echo "  make test       - Run health checks"
	@echo "  make logs       - Show container logs"
	@echo "  make status     - Show container status"
	@echo ""
	@echo "ğŸ’¡ Usage Examples:"
	@echo "  make deploy && make test    # Full deployment & test"
	@echo "  make logs                   # Monitor in real-time"

# Build Docker image
build:
	@echo "ğŸ“¦ Building nginx_reverse_proxy..."
	docker build -f docker/Dockerfile -t nginx_reverse_proxy .
	@echo "âœ… Build completed!"

# Deploy standalone
deploy:
	@echo "ğŸš€ Deploying nginx_reverse_proxy..."
	chmod +x scripts/deploy.sh
	./scripts/deploy.sh

# Integrate with main system
integrate:
	@echo "ğŸ”— Integrating with main system..."
	chmod +x scripts/integration.sh
	./scripts/integration.sh

# Stop container
stop:
	@echo "ğŸ›‘ Stopping nginx_reverse_proxy..."
	-docker stop nginx_reverse_proxy
	@echo "âœ… Container stopped"

# Clean up (stop + remove)
clean:
	@echo "ğŸ§¹ Cleaning up nginx_reverse_proxy..."
	-docker stop nginx_reverse_proxy
	-docker rm nginx_reverse_proxy
	@echo "âœ… Cleanup completed"

# Restart container
restart: stop
	@echo "ğŸ”„ Restarting nginx_reverse_proxy..."
	docker start nginx_reverse_proxy || make deploy
	@echo "âœ… Container restarted"

# Run health checks
test:
	@echo "ğŸ§ª Running health checks..."
	@echo "Testing nginx health..."
	@curl -f http://localhost/nginx-health && echo "âœ… Health: OK" || echo "âŒ Health: FAILED"
	@echo "Testing API routing..."
	@curl -I http://localhost/api/ &>/dev/null && echo "âœ… API: OK" || echo "âš ï¸  API: No backend"
	@echo "Testing frontend routing..."
	@curl -I http://localhost/ &>/dev/null && echo "âœ… Frontend: OK" || echo "âš ï¸  Frontend: No frontend"

# Show logs
logs:
	@echo "ğŸ“‹ Showing nginx_reverse_proxy logs..."
	docker logs -f nginx_reverse_proxy

# Show status
status:
	@echo "ğŸ“Š nginx_reverse_proxy Status:"
	@docker ps --filter "name=nginx_reverse_proxy" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}" || echo "Container not running"
	@echo ""
	@echo "ğŸŒ Endpoints:"
	@echo "  Health: http://localhost/nginx-health"
	@echo "  API:    http://localhost/api/"
	@echo "  Frontend: http://localhost/"

# Development helpers
dev-logs:
	@echo "ğŸ“‹ Development logs (access + error)..."
	@docker exec nginx_reverse_proxy sh -c "tail -f /var/log/nginx/access.log & tail -f /var/log/nginx/error.log" 2>/dev/null || echo "Container not running"

dev-shell:
	@echo "ğŸš Opening shell in nginx container..."
	docker exec -it nginx_reverse_proxy sh

dev-config:
	@echo "ğŸ”§ Showing nginx configuration..."
	docker exec nginx_reverse_proxy cat /etc/nginx/nginx.conf

# Network operations
network-create:
	@echo "ğŸ“¡ Creating lamacquina_network..."
	docker network create lamacquina_network || echo "Network already exists"

network-inspect:
	@echo "ğŸ” Inspecting lamacquina_network..."
	docker network inspect lamacquina_network

# Quick operations
quick-deploy: build deploy test

quick-restart: stop deploy test

quick-clean: clean build deploy test
