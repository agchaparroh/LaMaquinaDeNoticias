# Sistema de Orquestaci√≥n de Migraci√≥n - M√°quina de Noticias

## üìã Introducci√≥n

El sistema de orquestaci√≥n coordina la ejecuci√≥n completa de migraci√≥n de base de datos, incluyendo validaciones autom√°ticas, manejo de errores, rollbacks y monitoreo en tiempo real.

## üõ†Ô∏è Componentes del Sistema

### 1. Script Principal de Orquestaci√≥n
**Archivo:** `deploy.sh`  
**Prop√≥sito:** Coordinar toda la migraci√≥n con control granular

```bash
# Migraci√≥n completa con backup
./deploy.sh --backup --verbose

# Solo una categor√≠a espec√≠fica
./deploy.sh --category 03_tables

# Dry run para verificar
./deploy.sh --dry-run

# Migraci√≥n desde un punto espec√≠fico
./deploy.sh --start-from 04_indexes --stop-at 06_triggers
```

### 2. Sistema de Testing
**Archivo:** `test_migration.sh`  
**Prop√≥sito:** Validar migraci√≥n antes de producci√≥n

```bash
# Test completo con BD temporal
./test_migration.sh --mode full --create-test-db --cleanup

# Test de idempotencia
./test_migration.sh --mode idempotency --iterations 3

# Test de stress
./test_migration.sh --mode stress
```

### 3. Configuraci√≥n de Entornos
**Archivo:** `config/environments.conf`  
**Prop√≥sito:** Configuraciones espec√≠ficas por entorno

```bash
# Cargar configuraci√≥n
source config/environments.conf

# Configurar entorno de desarrollo
set_environment development

# Configurar producci√≥n con migraci√≥n inicial
set_environment production initial
```

## üöÄ Gu√≠a de Uso R√°pido

### Primera Migraci√≥n (Clean Database)

```bash
# 1. Configurar entorno
source config/environments.conf
set_environment development initial

# 2. Verificar configuraci√≥n
show_current_config

# 3. Test completo
./test_migration.sh --mode full --create-test-db --cleanup

# 4. Dry run
./deploy.sh --dry-run --backup

# 5. Ejecuci√≥n real
./deploy.sh --backup --verbose
```

### Migraci√≥n Incremental

```bash
# 1. Configurar para incremental
source config/environments.conf
set_environment staging incremental

# 2. Migraci√≥n espec√≠fica
./deploy.sh --category 05_functions --backup

# 3. Validaciones post-migraci√≥n
./deploy.sh --skip-validations --dry-run
```

### Despliegue en Producci√≥n

```bash
# 1. Configurar producci√≥n (DRY_RUN=true por defecto)
source config/environments.conf
set_environment production

# 2. Dry run obligatorio
./deploy.sh --verbose

# 3. Testing exhaustivo
./test_migration.sh --mode full

# 4. Habilitar ejecuci√≥n real (con confirmaci√≥n)
enable_real_execution

# 5. Ejecuci√≥n real con m√°xima seguridad
./deploy.sh --backup --stop-on-error
```

## ‚öôÔ∏è Opciones de Configuraci√≥n

### Variables de Entorno Principales

| Variable | Descripci√≥n | Default |
|----------|-------------|---------|
| `MIGRATION_ENV` | Entorno actual | development |
| `PGHOST` | Host PostgreSQL | localhost |
| `PGPORT` | Puerto PostgreSQL | 5432 |
| `PGDATABASE` | Base de datos | (requerido) |
| `PGUSER` | Usuario PostgreSQL | (requerido) |
| `MIGRATION_TIMEOUT` | Timeout por script (s) | 300 |
| `DRY_RUN` | Modo simulaci√≥n | false |
| `STOP_ON_ERROR` | Parar en errores | true |
| `BACKUP_BEFORE_DEPLOY` | Crear backup | false |

### Opciones del Script deploy.sh

| Opci√≥n | Descripci√≥n |
|--------|-------------|
| `--dry-run` | Modo simulaci√≥n sin cambios reales |
| `--category CATEGORIA` | Ejecutar solo una categor√≠a |
| `--start-from CATEGORIA` | Iniciar desde categor√≠a espec√≠fica |
| `--stop-at CATEGORIA` | Parar en categor√≠a espec√≠fica |
| `--skip-validations` | Omitir validaciones pre/post |
| `--force` | Continuar a pesar de advertencias |
| `--backup` | Crear backup antes de migraci√≥n |
| `--verbose` | Output detallado |
| `--continue-on-error` | Continuar en errores no cr√≠ticos |

## üìä Categor√≠as de Migraci√≥n

El sistema ejecuta las categor√≠as en orden espec√≠fico:

1. **01_schema** - Extensiones y esquemas b√°sicos
2. **02_types_domains** - Tipos y dominios personalizados  
3. **03_tables** - Tablas principales y particiones
4. **04_indexes** - √çndices B-tree, GIN y vectoriales
5. **05_functions** - Funciones PL/pgSQL y RPC
6. **06_triggers** - Triggers y automatizaciones
7. **07_materialized_views** - Vistas materializadas
8. **08_reference_data** - Datos de referencia y testing

### Ejecuci√≥n Granular

```bash
# Solo esquemas y tipos
./deploy.sh --start-from 01_schema --stop-at 02_types_domains

# Solo √≠ndices
./deploy.sh --category 04_indexes

# Desde funciones hasta el final
./deploy.sh --start-from 05_functions
```

## üîç Sistema de Validaciones Integrado

### Validaciones Autom√°ticas

El sistema ejecuta autom√°ticamente:
- **Pre-migraci√≥n**: Verificar entorno, extensiones, conflictos
- **Post-migraci√≥n**: Verificar objetos creados, integridad, funcionalidad

### Control de Validaciones

```bash
# Con validaciones completas (recomendado)
./deploy.sh --verbose

# Omitir validaciones (solo en desarrollo)
./deploy.sh --skip-validations

# Forzar continuaci√≥n en advertencias
./deploy.sh --force
```

## üìà Monitoreo y Logging

### Logs Autom√°ticos

Todos los scripts generan logs detallados:
- `logs/deployment_YYYYMMDD_HHMMSS.log` - Log de migraci√≥n
- `logs/test_migration_YYYYMMDD_HHMMSS.log` - Log de testing
- `logs/rollback_YYYYMMDD.log` - Log de rollbacks

### M√©tricas en Tiempo Real

```bash
# Progreso visual durante ejecuci√≥n
[2025-05-24 10:30:15] [INFO] [1/8] Ejecutando: 01_001_create_extensions_schemas.sql
Progreso: [=========>                     ] 30% - 03_tables
```

### Informaci√≥n de Estado

```bash
# Ver configuraci√≥n actual
show_current_config

# Validar entorno
validate_environment production

# Ver logs recientes
tail -f logs/deployment_$(date +%Y%m%d)*.log
```

## üõ°Ô∏è Estrategias de Seguridad

### Entornos de Producci√≥n

1. **DRY_RUN obligatorio**: Siempre ejecutar dry-run primero
2. **Backup autom√°tico**: Backup completo antes de cambios
3. **Validaciones estrictas**: Sin omitir validaciones
4. **Confirmaci√≥n expl√≠cita**: Requiere confirmaci√≥n para ejecuci√≥n real

### Manejo de Errores

```bash
# Parar en primer error (recomendado para producci√≥n)
./deploy.sh --stop-on-error

# Continuar en errores menores (desarrollo)
./deploy.sh --continue-on-error --force
```

### Rollback de Emergencia

```bash
# Rollback completo
./rollback.sh --confirm

# Rollback hasta punto espec√≠fico
./rollback.sh --to 03_001_create_tables.sql --confirm
```

## üß™ Testing y Validaci√≥n

### Tipos de Testing

| Modo | Descripci√≥n | Uso |
|------|-------------|-----|
| `full` | Testing completo con rollback | Pre-producci√≥n |
| `quick` | Validaciones r√°pidas | Desarrollo |
| `rollback` | Testing espec√≠fico de rollbacks | Validar rollbacks |
| `stress` | Testing de carga concurrente | Performance |
| `idempotency` | M√∫ltiples ejecuciones | Validar idempotencia |

### Estrategia de Testing Recomendada

```bash
# 1. Test r√°pido durante desarrollo
./test_migration.sh --mode quick

# 2. Test completo antes de staging
./test_migration.sh --mode full --create-test-db --cleanup

# 3. Test de idempotencia
./test_migration.sh --mode idempotency --iterations 3

# 4. Test de stress antes de producci√≥n
./test_migration.sh --mode stress
```

## üîÑ Flujo de Despliegue Completo

### Desarrollo ‚Üí Staging ‚Üí Producci√≥n

```bash
# DESARROLLO
set_environment development
./test_migration.sh --mode quick
./deploy.sh --verbose

# STAGING  
set_environment staging
./test_migration.sh --mode full --create-test-db --cleanup
./deploy.sh --backup --verbose

# PRODUCCI√ìN
set_environment production
./deploy.sh --dry-run --verbose              # Obligatorio
./test_migration.sh --mode stress            # Recomendado
enable_real_execution                        # Con confirmaci√≥n
./deploy.sh --backup --stop-on-error         # Ejecuci√≥n real
```

## üö® Troubleshooting

### Errores Comunes

**Error de conexi√≥n:**
```bash
# Verificar variables de entorno
echo $PGHOST $PGPORT $PGDATABASE $PGUSER

# Test de conexi√≥n manual
psql -c "SELECT version();"
```

**Script falla en categor√≠a espec√≠fica:**
```bash
# Ver log detallado
tail -f logs/deployment_*.log

# Ejecutar solo esa categor√≠a
./deploy.sh --category 03_tables --verbose

# Verificar scripts en la categor√≠a
ls -la 03_tables/
```

**Validaciones fallan:**
```bash
# Ver detalles de validaciones
psql -c "SELECT * FROM execute_pre_migration_validations();"

# Ejecutar con forzado (solo desarrollo)
./deploy.sh --force --continue-on-error
```

### Recuperaci√≥n de Errores

```bash
# 1. Verificar estado actual
psql -c "SELECT * FROM migration_history ORDER BY executed_at DESC LIMIT 5;"

# 2. Rollback si es necesario
./rollback.sh --dry-run
./rollback.sh --confirm

# 3. Corregir problema y reintentar
./deploy.sh --start-from <ultima_categoria_exitosa>
```

## üìö Scripts de Utilidad

### Verificaci√≥n de Estado

```bash
# Ver √∫ltimas migraciones
psql -c "SELECT script_name, status, executed_at FROM migration_history ORDER BY executed_at DESC LIMIT 10;"

# Ver rollbacks disponibles
psql -c "SELECT * FROM list_available_rollbacks();"

# Estad√≠sticas de validaciones
psql -c "SELECT * FROM generate_validation_report(7);"
```

### Mantenimiento

```bash
# Limpiar logs antiguos (>30 d√≠as)
find logs/ -name "*.log" -mtime +30 -delete

# Verificar estructura de migraci√≥n
./verify_structure.sh

# Validar rollbacks disponibles
psql -c "SELECT * FROM validate_rollback_implementation();"
```

## üéØ Mejores Pr√°cticas

### Antes de Migraci√≥n

1. ‚úÖ **Backup completo** de base de datos de producci√≥n
2. ‚úÖ **Testing exhaustivo** en entorno id√©ntico
3. ‚úÖ **Dry-run** m√∫ltiples veces
4. ‚úÖ **Validar rollbacks** disponibles
5. ‚úÖ **Coordinar con equipo** y stakeholders

### Durante Migraci√≥n

1. üìä **Monitorear logs** en tiempo real
2. üö® **Tener rollback listo** para ejecutar
3. ‚è±Ô∏è **Respetar timeouts** configurados
4. üìû **Mantener comunicaci√≥n** con equipo
5. üìù **Documentar problemas** encontrados

### Despu√©s de Migraci√≥n

1. ‚úÖ **Ejecutar validaciones post** completas
2. üß™ **Testing funcional** de aplicaci√≥n
3. üìä **Verificar m√©tricas** de rendimiento
4. üìö **Actualizar documentaci√≥n**
5. üéâ **Celebrar √©xito** del equipo

---

**üí° Tip**: Para nuevos usuarios, comenzar siempre con `./deploy.sh --dry-run` y `./test_migration.sh --mode quick` para familiarizarse con el sistema.
